# üîÄ Traefik - Modern Reverse Proxy

Este diret√≥rio cont√©m a configura√ß√£o completa do Traefik v3, um moderno reverse proxy e load balancer com descoberta autom√°tica de servi√ßos, SSL autom√°tico e dashboard web.

## üéØ Funcionalidades

### üöÄ **Core Features**
- **Auto Service Discovery**: Descobre servi√ßos Docker automaticamente
- **SSL/TLS Autom√°tico**: Let's Encrypt integration
- **Load Balancing**: M√∫ltiplos algoritmos de balanceamento
- **Middlewares**: Rate limiting, autentica√ß√£o, headers de seguran√ßa
- **Dashboard Web**: Interface gr√°fica para monitoramento

### üìä **Monitoring & Observability**
- **M√©tricas Prometheus**: Exposi√ß√£o de m√©tricas para monitoramento
- **Logs Estruturados**: Access logs e error logs
- **Health Checks**: Verifica√ß√£o de sa√∫de dos servi√ßos
- **Real-time Dashboard**: Visualiza√ß√£o em tempo real

---

## üöÄ In√≠cio R√°pido

### 1. **Inicializar Traefik**
```bash
# Usando o script de gerenciamento
./traefik-manager.sh start

# Ou manualmente
docker network create traefik-network
docker compose up -d
```

### 2. **Verificar Status**
```bash
./traefik-manager.sh status
```

### 3. **Acessar Dashboard**
- **Local**: http://localhost:8080
- **Domain**: http://traefik.localhost (adicionar ao /etc/hosts)
- **M√©tricas**: http://localhost:8080/metrics

---

## üìä Interfaces de Acesso

| Servi√ßo       | URL                           | Descri√ß√£o                      |
| ------------- | ----------------------------- | ------------------------------ |
| **Dashboard** | http://localhost:8080         | Interface principal do Traefik |
| **API**       | http://localhost:8080/api     | API REST para configura√ß√£o     |
| **M√©tricas**  | http://localhost:8080/metrics | M√©tricas Prometheus            |
| **Health**    | http://localhost:8080/ping    | Health check endpoint          |

---

## üîß Configura√ß√£o

### üìÅ **Estrutura de Arquivos**
```
006-traefik/
‚îú‚îÄ‚îÄ docker-compose.yaml           # Configura√ß√£o principal
‚îú‚îÄ‚îÄ traefik-manager.sh            # Script de gerenciamento
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ middlewares.yml           # Middlewares personalizados
‚îÇ   ‚îî‚îÄ‚îÄ services-examples.yml     # Exemplos de servi√ßos
‚îú‚îÄ‚îÄ logs/                         # Logs do Traefik
‚îî‚îÄ‚îÄ letsencrypt/                  # Certificados SSL
    ‚îî‚îÄ‚îÄ acme.json                 # Dados do Let's Encrypt
```

### ‚öôÔ∏è **Configura√ß√µes Principais**

#### **Entry Points**
- **Port 80**: HTTP traffic
- **Port 443**: HTTPS traffic  
- **Port 8080**: Dashboard e API

#### **Providers**
- **Docker**: Auto-discovery de containers
- **File**: Configura√ß√µes din√¢micas em YAML

#### **Certificate Resolvers**
- **Let's Encrypt**: SSL autom√°tico via HTTP challenge

---

## üê≥ Adicionando Servi√ßos ao Traefik

### **M√©todo 1: Labels no Docker Compose**

```yaml
version: '3.8'

services:
  my-app:
    image: nginx:alpine
    labels:
      # Habilitar Traefik
      - traefik.enable=true
      
      # Configurar rota HTTP
      - traefik.http.routers.my-app.rule=Host(`app.localhost`)
      - traefik.http.routers.my-app.entrypoints=web
      - traefik.http.services.my-app.loadbalancer.server.port=80
      
      # Configurar rota HTTPS (produ√ß√£o)
      - traefik.http.routers.my-app-secure.rule=Host(`app.yourdomain.com`)
      - traefik.http.routers.my-app-secure.entrypoints=websecure
      - traefik.http.routers.my-app-secure.tls=true
      - traefik.http.routers.my-app-secure.tls.certresolver=letsencrypt
      
      # Middlewares
      - traefik.http.routers.my-app.middlewares=compression,security-headers
      
    networks:
      - traefik-network

networks:
  traefik-network:
    external: true
```

### **M√©todo 2: Configura√ß√£o Din√¢mica (File Provider)**

Criar arquivo em `config/my-service.yml`:

```yaml
http:
  routers:
    my-service:
      rule: "Host(`api.localhost`)"
      entrypoints:
        - "web"
      service: "my-service"
      middlewares:
        - "rate-limit"
        - "security-headers"

  services:
    my-service:
      loadBalancer:
        servers:
          - url: "http://my-api:8080"
        healthCheck:
          path: "/health"
          interval: "30s"
```

---

## üõ†Ô∏è Comandos √öteis

### **Script de Gerenciamento**
```bash
# Iniciar Traefik
./traefik-manager.sh start

# Parar Traefik
./traefik-manager.sh stop

# Reiniciar Traefik
./traefik-manager.sh restart

# Ver status
./traefik-manager.sh status

# Ver logs
./traefik-manager.sh logs

# Validar configura√ß√£o
./traefik-manager.sh validate

# Adicionar servi√ßo √† rede
./traefik-manager.sh add-service container-name

# Gerar hash de autentica√ß√£o
./traefik-manager.sh generate-auth admin password123
```

### **Docker Commands**
```bash
# Ver logs em tempo real
docker compose logs -f traefik

# Recarregar configura√ß√£o
docker compose restart traefik

# Verificar containers na rede
docker network inspect traefik-network

# Conectar container existente
docker network connect traefik-network container-name
```

### **API Calls**
```bash
# Listar routers
curl -s http://localhost:8080/api/http/routers | jq .

# Listar servi√ßos
curl -s http://localhost:8080/api/http/services | jq .

# Ver middlewares
curl -s http://localhost:8080/api/http/middlewares | jq .

# Health check
curl http://localhost:8080/ping
```

---

## üîí Middlewares Dispon√≠veis

### **Seguran√ßa**
- **security-headers**: Headers de seguran√ßa padr√£o
- **basic-auth**: Autentica√ß√£o HTTP b√°sica
- **admin-whitelist**: Whitelist de IPs para admin
- **redirect-to-https**: Redirecionamento para HTTPS

### **Performance**
- **compression**: Compress√£o gzip/brotli
- **rate-limit**: Limita√ß√£o de rate por IP
- **strip-prefix**: Remo√ß√£o de prefixos de URL

### **Exemplo de Uso**
```yaml
labels:
  - traefik.http.routers.app.middlewares=compression,security-headers,rate-limit
```

---

## üìà Integra√ß√£o com Prometheus

### **M√©tricas Dispon√≠veis**
- `traefik_service_requests_total`: Total de requests por servi√ßo
- `traefik_service_request_duration_seconds`: Dura√ß√£o dos requests
- `traefik_entrypoint_requests_total`: Requests por entrypoint
- `traefik_router_requests_total`: Requests por router

### **Configura√ß√£o no Prometheus**
```yaml
scrape_configs:
  - job_name: 'traefik'
    static_configs:
      - targets: ['traefik:8080']
    scrape_interval: 15s
    metrics_path: '/metrics'
```

### **Queries √öteis**
```promql
# Rate de requests
rate(traefik_service_requests_total[5m])

# Lat√™ncia m√©dia
rate(traefik_service_request_duration_seconds_sum[5m]) / rate(traefik_service_request_duration_seconds_count[5m])

# C√≥digos de erro
increase(traefik_service_requests_total{code=~"4..|5.."}[5m])
```

---

## üåê Configura√ß√£o de Produ√ß√£o

### **1. HTTPS Obrigat√≥rio**
Descomente no docker-compose.yaml:
```yaml
# Global redirect from HTTP to HTTPS
- --entrypoints.web.http.redirections.entrypoint.to=websecure
- --entrypoints.web.http.redirections.entrypoint.scheme=https
```

### **2. Dashboard Seguro**
```yaml
labels:
  - traefik.http.routers.traefik-secure.rule=Host(`traefik.yourdomain.com`)
  - traefik.http.routers.traefik-secure.entrypoints=websecure
  - traefik.http.routers.traefik-secure.tls=true
  - traefik.http.routers.traefik-secure.tls.certresolver=letsencrypt
  - traefik.http.routers.traefik-secure.middlewares=traefik-auth
```

### **3. Configurar Email para Let's Encrypt**
```yaml
- --certificatesresolvers.letsencrypt.acme.email=admin@yourdomain.com
```

### **4. Desabilitar API Insecura**
```yaml
- --api.insecure=false
```

---

## üîç Troubleshooting

### **Problemas Comuns**

#### **1. Servi√ßo n√£o aparece no dashboard**
```bash
# Verificar se container est√° na rede
docker network inspect traefik-network

# Verificar labels
docker inspect container-name | jq '.[0].Config.Labels'

# Verificar logs
./traefik-manager.sh logs
```

#### **2. SSL n√£o funciona**
```bash
# Verificar acme.json
ls -la letsencrypt/acme.json

# Verificar permiss√µes
chmod 600 letsencrypt/acme.json

# Verificar logs do Let's Encrypt
docker compose logs traefik | grep -i acme
```

#### **3. 404 Gateway Timeout**
```bash
# Verificar se servi√ßo est√° rodando
docker ps | grep service-name

# Verificar conectividade
docker exec traefik ping service-name

# Verificar configura√ß√£o do servi√ßo
curl -s http://localhost:8080/api/http/services | jq '.[] | select(.name=="service-name")'
```

#### **4. Rate Limit atingido**
```bash
# Verificar middleware de rate limit
curl -s http://localhost:8080/api/http/middlewares | jq '.[] | select(.name=="rate-limit")'

# Ajustar configura√ß√£o em config/middlewares.yml
```

### **Logs √öteis**
```bash
# Todos os logs
./traefik-manager.sh logs

# Apenas erros
docker compose logs traefik | grep -i error

# Access logs
tail -f logs/access.log

# Logs espec√≠ficos do Let's Encrypt
docker compose logs traefik | grep -i "acme\|letsencrypt"
```

---

## üîÑ Exemplos de Integra√ß√£o

### **WordPress com SSL**
```yaml
wordpress:
  image: wordpress:latest
  labels:
    - traefik.enable=true
    - traefik.http.routers.wp.rule=Host(`blog.yourdomain.com`)
    - traefik.http.routers.wp.entrypoints=websecure
    - traefik.http.routers.wp.tls=true
    - traefik.http.routers.wp.tls.certresolver=letsencrypt
    - traefik.http.services.wp.loadbalancer.server.port=80
  networks:
    - traefik-network
```

### **API com Rate Limiting**
```yaml
api:
  image: my-api:latest
  labels:
    - traefik.enable=true
    - traefik.http.routers.api.rule=Host(`api.yourdomain.com`)
    - traefik.http.routers.api.middlewares=rate-limit,security-headers
    - traefik.http.services.api.loadbalancer.server.port=8080
  networks:
    - traefik-network
```

### **Admin Panel com Autentica√ß√£o**
```yaml
admin:
  image: admin-panel:latest
  labels:
    - traefik.enable=true
    - traefik.http.routers.admin.rule=Host(`admin.yourdomain.com`)
    - traefik.http.routers.admin.middlewares=basic-auth,admin-whitelist
    - traefik.http.services.admin.loadbalancer.server.port=3000
  networks:
    - traefik-network
```

---

## üìö Pr√≥ximos Passos

1. **üîê Configurar autentica√ß√£o** para dashboard em produ√ß√£o
2. **üìä Integrar com Grafana** para dashboards visuais
3. **üîÑ Setup de backup** para configura√ß√µes e certificados
4. **üåê Configurar DNS** para dom√≠nios personalizados
5. **üì± Adicionar mais middlewares** conforme necess√°rio
6. **üîç Configurar logging centralizado**

---

## üìû Refer√™ncias

- [Documenta√ß√£o Oficial do Traefik](https://doc.traefik.io/traefik/)
- [Traefik v3 Migration Guide](https://doc.traefik.io/traefik/migration/v2-to-v3/)
- [Let's Encrypt Integration](https://doc.traefik.io/traefik/https/acme/)
- [Docker Provider](https://doc.traefik.io/traefik/providers/docker/)
- [Middlewares Reference](https://doc.traefik.io/traefik/middlewares/http/overview/)

---

## ‚úÖ Status: TRAEFIK CONFIGURADO

üéâ **O Traefik est√° completamente configurado e pronto para uso!**

**Para iniciar:** `./traefik-manager.sh start`
